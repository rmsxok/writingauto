<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ê¸€ì“°ê¸° ìë™í™” Â· 3ë‹¨ê³„ ë§ˆë²•ì‚¬ (Responsive)</title>

  <!-- React / ReactDOM / Babel (ê°œë°œìš© CDN) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin></script>

  <style>
    /* ---- ê¸€ë¡œë²Œ ë¦¬ì…‹ & ëª¨ë°”ì¼ ë„˜ì¹¨ ë°©ì§€ ---- */
    * { box-sizing: border-box; }
    html,body,#root{height:100%;margin:0}
    body{font-family:"Noto Sans KR",system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,"ë§‘ì€ ê³ ë”•",Arial,sans-serif;
         -webkit-text-size-adjust:100%; background:#0b0c0f; color:#e7eaf0;}
    input,select,textarea{ font-size:16px; max-width:100%; } /* iOS í™•ëŒ€/ë„˜ì¹¨ ë°©ì§€ */
    ::-webkit-scrollbar{height:10px;width:10px}
    ::-webkit-scrollbar-thumb{background:#1f2430;border-radius:8px}

    /* ---- ë°˜ì‘í˜• ê·¸ë¦¬ë“œ: 4ì—´ â†’ 2ì—´ â†’ 1ì—´ ---- */
    :root{ --gap:18px; }
    .grid-4{
      display:grid;
      grid-template-columns: 240px 1fr 240px 1fr; /* (ë¼ë²¨)(ì…ë ¥) Ã— 2ì„¸íŠ¸ */
      column-gap: var(--gap);
      row-gap: 20px;
      scroll-margin-top: 76px; /* sticky í—¤ë” ê³ ë ¤ */
    }
    @media (max-width:1024px){
      .grid-4{ grid-template-columns: 1fr 1fr; }
      .ctrl-span-3{ grid-column: 1 / -1 !important; }
    }
    @media (max-width:768px){
      .grid-4{ grid-template-columns: 1fr; row-gap:14px; }
      .ctrl-span-3{ grid-column: 1 / -1 !important; }
    }

    /* ---- ì§„í–‰ ìˆœì„œ ì¹©: ìŠ¤ëƒ… + ê·¸ë¼ë””ì–¸íŠ¸ ë§ˆìŠ¤í¬ ---- */
    .flow-wrap{ position:relative; }
    .flow-chips{
      display:flex; gap:8px; overflow-x:auto; -webkit-overflow-scrolling:touch;
      padding:6px 4px 10px; scrollbar-width:thin; scroll-snap-type:x proximity;
      mask-image: linear-gradient(to right, transparent 0, black 24px, black calc(100% - 24px), transparent 100%);
    }
    .flow-chips > span{ scroll-snap-align:start; }
    .chip{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:9999; font-size:12px; cursor:pointer; }

    /* ---- ëª¨ë°”ì¼ ë²„íŠ¼ í­ ---- */
    @media (max-width:768px){ .mb-full{ width:100%; } }

    /* ---- ë³¸ë¬¸ ì½ê¸° ì¹´ë“œ/ëª¨ë‹¬ ---- */
    .read-card{
      border:1px solid #1b1e25; border-radius:16px; background:#0f1217; padding:16px; 
      line-height:1.7; letter-spacing:.01em;
    }
    .read-card h1,.read-card h2,.read-card h3{ color:#e9edf7; }
    .read-card ul{ padding-left:20px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const {useState,useEffect,useMemo,useRef,useLayoutEffect} = React;

    function NaverWizardDark(){
      /* =================== Theme & State =================== */
      const palette = {
        bg:"#0b0c0f", card:"#111318", border:"#1b1e25",
        text:"#e7eaf0", muted:"#9aa3b2",
        accent:"#a3bffa", accentPress:"#7aa2f7",
        chip:"#0c0f14", chipActive:"#12203a", chipRing:"#3656ff66",
        danger:"#fda4a4"
      };
      const OPENAI_MODEL = "gpt-4o-mini"; // ì•ˆì •/ê°€ì„±ë¹„

      const [activeStep,setActiveStep] = useState(3);

      // step1
      const [useAI,setUseAI] = useState(false);
      const [apiKey,setApiKey] = useState("");

      // step2
      const [keyword,setKeyword] = useState("");
      const [searchIntent,setSearchIntent] = useState("info");
      const [angle,setAngle] = useState("solve");
      const [toneLevel,setToneLevel] = useState(3);
      const [titleFormat,setTitleFormat] = useState("auto");
      const [formatOpen,setFormatOpen] = useState(false);
      const [mustInclude,setMustInclude] = useState("");
      const [avoidTerms,setAvoidTerms] = useState("");
      const [referenceText,setReferenceText] = useState("");
      const [titleCount,setTitleCount] = useState(5);
      const [titleIdeas,setTitleIdeas] = useState([]);
      const [selectedTitle,setSelectedTitle] = useState("");
      const [flowActive,setFlowActive] = useState(1);

      // step3
      const [minChars,setMinChars] = useState(1200);
      const [markdown,setMarkdown] = useState("");
      const [autoSpacing,setAutoSpacing] = useState(true);
      const [referencePrompt,setReferencePrompt] = useState("");
      const [bodyMode,setBodyMode] = useState("ai"); // 'ai' | 'local'
      const [genBusy,setGenBusy] = useState(false);
      const [readerOpen,setReaderOpen] = useState(false);

      // common
      const [loading,setLoading] = useState(false);
      const [reviewing,setReviewing] = useState(false);
      const [error,setError] = useState("");

      useEffect(()=>{ setApiKey(localStorage.getItem("naverWizard_openai_key")||""); },[]);
      useEffect(()=>{ localStorage.setItem("naverWizard_openai_key", apiKey||""); },[apiKey]);

      /* ============= ê³µí†µ ìŠ¤íƒ€ì¼ (inline) ============= */
      const styles = {
        app:{ backgroundColor:palette.bg, color:palette.text, minHeight:"100vh",
              paddingBottom:"calc(120px + env(safe-area-inset-bottom))" },
        header:{ position:"sticky", top:0, backdropFilter:"blur(6px)", borderBottom:`1px solid ${palette.border}`, background:"rgba(11,12,15,.65)", marginBottom:16, zIndex:10 },
        container:{ maxWidth:1200, margin:"0 auto", padding:"12px" },
        logo:{ width:36, height:36, borderRadius:16, display:"grid", placeItems:"center", fontWeight:700, background:"linear-gradient(180deg,#20314f,#101828)", color:"#dbe7ff" },
        tabs:{ display:"flex", gap:8, marginBottom:12, flexWrap:"wrap" },
        tab:(active)=>({ border:`1px solid ${palette.border}`, borderRadius:12, padding:"10px 14px", background:active?"#111827":"#0c0f14", color:active?palette.text:palette.muted, cursor:"pointer", minWidth:90 }),
        card:{ background:palette.card, border:`1px solid ${palette.border}`, borderRadius:16, padding:20, marginBottom:16 },
        stepHead:{ borderBottom:`1px solid ${palette.border}`, paddingBottom:8, marginBottom:12, display:"flex", alignItems:"center", justifyContent:"space-between", gap:8, flexWrap:"wrap" },
        pill:{ padding:"2px 9px", borderRadius:9999, fontSize:12, background:"#0f1116", color:palette.muted, border:`1px solid ${palette.border}` },

        labelRow:{ display:"flex", alignItems:"center", gap:6, color:palette.muted, fontSize:12, lineHeight:1.3, minHeight:24 },
        ctrlWrap:{},
        helpChip:{ position:"relative", display:"inline-flex", alignItems:"center", justifyContent:"center",
                   width:18, height:18, borderRadius:"50%", background:"#0e1524", color:"#cfe0ff",
                   border:`1px solid ${palette.border}`, cursor:"pointer", fontWeight:700, fontSize:12, userSelect:"none", flex:"0 0 auto" },
        tooltipBox:{ position:"fixed", background:"#0e1117", color:palette.text, border:`1px solid ${palette.border}`,
                     borderRadius:8, padding:"8px 10px", maxWidth:320, zIndex:1000, boxShadow:"0 10px 22px rgba(0,0,0,.45)", fontSize:12 },

        input:{ background:"#0e1117", color:palette.text, border:`1px solid ${palette.border}`, borderRadius:12, padding:"12px 12px", width:"100%" },
        number:{ background:"#0e1117", color:palette.text, border:`1px solid ${palette.border}`, borderRadius:12, padding:"12px 12px", width:"100%" },
        textarea:{ background:"#0e1117", color:palette.text, border:`1px solid ${palette.border}`, borderRadius:12, padding:12, width:"100%", minHeight:110 },
        ring:(active)=> active ? ({ borderColor:palette.accentPress, boxShadow:`0 0 0 2px ${palette.chipRing}` }) : ({}),

        h3:{ fontWeight:600, marginBottom:8, color:"#e9edf7" },
        prose:{ border:`1px solid ${palette.border}`, background:palette.card, borderRadius:16, padding:16, minHeight:240, overflowX:"auto" },
        btn:{ backgroundImage:`linear-gradient(180deg, ${palette.accent}, ${palette.accentPress})`, color:"#0b1020", fontWeight:600, borderRadius:14, padding:"10px 16px", border:0, cursor:"pointer" },
        btnGhost:{ background:"transparent", color:palette.text, border:`1px solid ${palette.border}`, borderRadius:12, padding:"9px 14px", cursor:"pointer" },
        note:{ fontSize:12, color:palette.muted },

        stickyMobile:{ position:"fixed", bottom:0, left:0, right:0, background:"rgba(11,12,15,.9)", borderTop:`1px solid ${palette.border}`,
                       padding:"10px", paddingBottom:"calc(10px + env(safe-area-inset-bottom))",
                       display:"flex", gap:8, justifyContent:"space-between", zIndex:20 },

        overlay:{ position:"fixed", inset:0, background:"rgba(0,0,0,.6)", display:"flex", alignItems:"center", justifyContent:"center", zIndex:1000 },
        reader:{ width:"min(1000px, 92vw)", height:"min(80vh, 760px)", background:palette.card, border:`1px solid ${palette.border}`, borderRadius:16, padding:16, overflow:"auto" }
      };

      /* ====== íˆ´íŒ: ë·°í¬íŠ¸ ë°– ë°©ì§€ ====== */
      function Help({text}){
        const btnRef = useRef(null);
        const tipRef = useRef(null);
        const [open,setOpen] = useState(false);
        const [pos,setPos] = useState({top:0,left:0});

        const place = () => {
          if(!btnRef.current) return;
          const r = btnRef.current.getBoundingClientRect();
          const estW = Math.min(320, Math.max(220, window.innerWidth*0.92));
          const estH = 140;
          let left = r.left + r.width/2 - estW/2;
          left = Math.max(8, Math.min(left, window.innerWidth - estW - 8));
          let top = r.bottom + 8;
          if (top + estH > window.innerHeight - 8) { top = r.top - estH - 8; if (top < 8) top = 8; }
          setPos({top,left});
          setTimeout(()=>{
            if (!tipRef.current) return;
            const tr = tipRef.current.getBoundingClientRect();
            let l = tr.left, t = tr.top;
            if (tr.right > window.innerWidth - 8) l -= (tr.right - (window.innerWidth - 8));
            if (tr.left < 8) l = 8;
            if (tr.bottom > window.innerHeight - 8) t -= (tr.bottom - (window.innerHeight - 8));
            if (tr.top < 8) t = 8;
            tipRef.current.style.left = `${l}px`;
            tipRef.current.style.top  = `${t}px`;
          },0);
        };

        useLayoutEffect(()=>{ if(open) place(); },[open]);
        useEffect(()=>{
          const h=()=> open && place();
          window.addEventListener('scroll',h,true);
          window.addEventListener('resize',h);
          return ()=>{ window.removeEventListener('scroll',h,true); window.removeEventListener('resize',h); };
        },[open]);

        return (
          <>
            <span
              ref={btnRef}
              style={styles.helpChip}
              onMouseEnter={()=>setOpen(true)}
              onMouseLeave={()=>setOpen(false)}
              onClick={()=>setOpen(o=>!o)}
              onTouchStart={(e)=>{ e.preventDefault(); setOpen(o=>!o); }}
              aria-label="ë„ì›€ë§"
            >?</span>
            {open && <div ref={tipRef} style={{...styles.tooltipBox, top:pos.top, left:pos.left, maxWidth:"92vw" }}>{text}</div>}
          </>
        );
      }

      /* ===== Markdown â†’ HTML ===== */
      function mdToHtml(md){
        let h = md || "";
        h = h.replace(/^# (.+)$/gm, "<h1>$1</h1>");
        h = h.replace(/^## (.+)$/gm, "<h2>$1</h2>");
        h = h.replace(/^### (.+)$/gm, "<h3>$1</h3>");
        h = h.replace(/^> (.+)$/gm, "<blockquote>$1</blockquote>");
        h = h.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
        h = h.replace(/\*(.+?)\*/g, "<em>$1</em>");
        h = h.replace(/`([^`]+)`/g, "<code>$1</code>");
        h = h.replace(/^\s*[-*]\s+(.+)$/gm, "<li>$1</li>");
        h = h.replace(/(<li>.*<\/li>\n?)+/g, (m) => "<ul>" + m + "</ul>");
        h = h.replace(/\n\n+/g, "<br/><br/>");
        return h;
      }
      const html = useMemo(()=>mdToHtml(markdown),[markdown]);

      /* === ì—¬ê¸°ì„œë¶€í„° 2/2 ì´ì–´ë¶™ì´ê¸° === */
            /* ===== ìœ í‹¸ ===== */
      function topTerms(text,k=5){
        const stop=new Set(["ê·¸ë¦¬ê³ ","ê·¸ëŸ¬ë‚˜","í•˜ì§€ë§Œ","ë˜ëŠ”","ë˜","ì´ë¯¸","ë˜í•œ","ê·¸","ì´","ì €","ê²ƒ","ìˆ˜","ë•Œë¬¸","ëŒ€í•œ","ì—ì„œ","ìœ¼ë¡œ","í•˜ê¸°","í•˜ëŠ”","ìˆëŠ”","ì—†ëŠ”","í•©ë‹ˆë‹¤","í–ˆë‹¤","ì´ë‹¤","ê°™ì€","ë“±","ë”","ì¢€","ë§¤ìš°","ë„ˆë¬´","ë˜ë‹¤","í•˜ë‹¤","ìˆë‹¤","ì—†ë‹¤"]);
        const c=Object.create(null);
        (text||"").toLowerCase().replace(/[^\p{L}\p{N}\s]/gu," ").split(/\s+/)
          .filter(w=>w&&w.length>1&&!stop.has(w)).forEach(w=>{c[w]=(c[w]||0)+1});
        return Object.entries(c).sort((a,b)=>b[1]-a[1]).slice(0,k).map(([w])=>w);
      }

      /* ===== ì œëª© ìƒì„± ë¡œì»¬/AI ===== */
      function buildContextSnippet(){
        const parts=[];
        const angleName={solve:"ë¬¸ì œ-í•´ê²°",myth:"ì˜¤í•´ ë°”ë¡œì¡ê¸°",check:"ì²´í¬ë¦¬ìŠ¤íŠ¸",compare:"ë¹„êµ/ëŒ€ì•ˆ",mistake:"ì‹¤ìˆ˜ íšŒí”¼"}[angle]||angle;
        const intentName={info:"ì •ë³´í˜•",compare:"ë¹„êµí˜•",trans:"ê±°ë˜ì „í™˜í˜•",qa:"Q&A ìš”ì•½"}[searchIntent]||searchIntent;
        parts.push(`ê°ë„:${angleName}`,`ì˜ë„:${intentName}`);
        if(mustInclude.trim()) parts.push(`í¬í•¨:${mustInclude.trim()}`);
        if(avoidTerms.trim()) parts.push(`ì œì™¸:${avoidTerms.trim()}`);
        const ref = referenceText.trim() ? `ì°¸ê³ :${referenceText.trim().slice(0,180)}â€¦` : "";
        return (parts.join(" / ") + (ref ? " / " + ref : "")).trim();
      }
      function generateTitleIdeasLocal(baseKeyword,n,ref,opts={toneLevel:3,format:"auto"}){
        if(!baseKeyword||!baseKeyword.trim()) return [];
        const base = baseKeyword.trim();
        const refTerms = topTerms(ref,4);
        const refHint = refTerms.length ? ` (${refTerms.join(" Â· ")})` : "";
        const ctx = buildContextSnippet();
        const em = opts.toneLevel ?? 3;
        const emotional = em <= 2.0, rational = em >= 4.0;

        const emoHooks=[`${base}ì˜ ìˆ¨ì€ í˜œíƒ`,`${base}ë¡œ ë‹¬ë¼ì§€ëŠ” í•˜ë£¨`,`${base}ë¥¼ ì•Œë©´ í¸í•´ì§€ëŠ” ì´ìœ `,`${base} ì‘ì€ ë¹„ë°€`];
        const ratHooks=[`${base} í•µì‹¬ ì§€í‘œ`,`${base} 3ê°€ì§€ í•µì‹¬`,`${base} ì‹¤ë¬´ ì²´í¬ë¦¬ìŠ¤íŠ¸`,`${base} ë°ì´í„°ë¡œ ë³´ëŠ” ë³€í™”`];
        const angleFrames={
          solve:[`${base} ë¬¸ì œ í•´ê²° ê°€ì´ë“œ`,`${base} ì´ë ‡ê²Œ í•˜ë©´ í’€ë¦½ë‹ˆë‹¤`],
          myth:[`${base}ì— ëŒ€í•œ í”í•œ ì˜¤í•´ 3ê°€ì§€`,`${base} ì‚¬ì‹¤ê³¼ ì˜¤í•´`],
          check:[`${base} ì ê²€ ì²´í¬ë¦¬ìŠ¤íŠ¸`,`${base} ì¤€ë¹„ë¬¼/ì¡°ê±´ ì´ì •ë¦¬`],
          compare:[`${base} ë¹„êµ: ì„ íƒ ê¸°ì¤€ê³¼ ëŒ€ì•ˆ`,`${base} vs ìœ ì‚¬ ê°œë…: ì°¨ì´ì™€ í™œìš©`],
          mistake:[`${base} í•  ë•Œ í”í•œ ì‹¤ìˆ˜ì™€ í”¼í•˜ëŠ” ë²•`,`${base} ì‹¤íŒ¨ ì¤„ì´ëŠ” ë²•`],
        }[angle]||[];
        const intentFrames={
          info:[`${base} í•µì‹¬ë§Œ ìš”ì•½`,`${base} ë¬´ì—‡ë¶€í„° ì•Œë©´ ì¢‹ì„ê¹Œ?`],
          compare:[`${base} ì„ íƒ ê°€ì´ë“œ`,`${base} ë¹„êµí‘œë¡œ ë³´ëŠ” ì°¨ì´`],
          trans:[`ì™œ ì§€ê¸ˆ ${base}ë¥¼ ê³ ë ¤í•´ì•¼ í• ê¹Œ`,`${base} ë„ì… ì „ í™•ì¸í•  3ê°€ì§€`],
          qa:[`${base} Q&A: ìì£¼ ë¬»ëŠ” ì§ˆë¬¸`,`${base} ìƒë‹´ì „ ë¯¸ë¦¬ ë³´ëŠ” í•µì‹¬`],
        }[searchIntent]||[];

        const frames=[
          ...(emotional?[`${emoHooks[0]}: ì•Œì•„ë‘ë©´ ë“ì´ ë˜ëŠ” ê°€ì´ë“œ${refHint||""}`,`ëª¨ë‘ê°€ ì§€ë‚˜ì¹˜ëŠ” ${base}ì˜ ${emoHooks[3]}${refHint||""}`]:[]),
          ...(rational?[`${ratHooks[1]}: ì‹¤ì „ ì ìš© í¬ì¸íŠ¸${refHint||""}`,`${base} ${ratHooks[2]} (ì‹¤ë¬´ ê¸°ì¤€)${refHint||""}`]:[]),
          ...angleFrames.map(f=>`${f}${ctx ? " Â· " + ctx : ""}`),
          ...intentFrames.map(f=>`${f}${ctx ? " Â· " + ctx : ""}`),
          `${base} ìµœì‹  íŠ¸ë Œë“œì™€ ì‚¬ë¡€: ì§€ê¸ˆ ì ìš©í•˜ëŠ” ë²•${refHint}`,
          `${base} í•µì‹¬ë§Œ ìš”ì•½: ê¼­ ì•Œì•„ì•¼ í•  ì²´í¬í¬ì¸íŠ¸${refHint}`,
        ];

        function byFormat(s){
          switch(opts.format){
            case "question": return `${base}ëŠ” ë¬´ì—‡ì¼ê¹Œ? ${refTerms[0]?`(${refTerms[0]})`:""}`.trim();
            case "command":  return `ì§€ê¸ˆ ì•Œì•„ì•¼ í•  ${base} í•µì‹¬ ê°€ì´ë“œ`;
            case "list":     return `${base} í•µì‹¬ í¬ì¸íŠ¸ 3ê°€ì§€`;
            case "compare":  return `${base} ì „/í›„ ë¹„êµ: ë‹¬ë¼ì§„ ì ê³¼ ëŒ€ì‘`;
            default:         return s;
          }
        }
        const mustList = mustInclude.split(",").map(s=>s.trim()).filter(Boolean);
        const avoidList = avoidTerms.split(",").map(s=>s.trim()).filter(Boolean);

        const shuffled = [...frames].sort(()=>Math.random()-0.5);
        const count = Math.max(1,Number(n)||5), out=[], used=new Set();
        for(let i=0;i<shuffled.length && out.length<count;i++){
          let f = byFormat(shuffled[i]);
          if (mustList.length && !mustList.every(w=>f.includes(w))) f += " Â· " + mustList.filter(w=>!f.includes(w)).join(" ");
          if (avoidList.some(w=>w && f.includes(w))) continue;
          if (!used.has(f)) { used.add(f); out.push(f); }
        }
        while(out.length<count){
          const fb = `${base} ê°€ì´ë“œ: ì‹œì‘í•˜ëŠ” ë²•${ctx ? " Â· " + ctx : ""}`;
          if (!avoidList.some(w=>fb.includes(w))) out.push(fb); else break;
        }
        return out.slice(0,count);
      }

      async function generateTitleIdeasAI({ baseKeyword, n, ref, opts }){
        if(!apiKey) throw new Error("OpenAI API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.");
        const payload = {
          model: OPENAI_MODEL,
          messages: [
            { role: "system", content: "You generate Korean blog title ideas only. Return STRICT JSON with the schema {\"titles\":[\"...\"]}." },
            { role: "user", content:
`í‚¤ì›Œë“œ: ${baseKeyword}
ì œëª© ê°œìˆ˜: ${Math.max(1, Number(n)||5)}
ì°¸ê³  ë‚´ìš©(ì„ íƒ): ${(ref||"").slice(0, 2000)}
ì œëª© í˜•ì‹: ${opts?.format || 'auto'}
í†¤(1=ê°ì„±,5=ì´ì„±): ${opts?.toneLevel ?? 3}
- ê°ë„/í›„í‚¹: ${({"solve":"ë¬¸ì œ-í•´ê²°","myth":"ì˜¤í•´ ë°”ë¡œì¡ê¸°","check":"ì²´í¬ë¦¬ìŠ¤íŠ¸","compare":"ë¹„êµ/ëŒ€ì•ˆ","mistake":"ì‹¤ìˆ˜ íšŒí”¼"}[angle] || angle)}
- í¬í•¨ ë‹¨ì–´: ${mustInclude || "ì—†ìŒ"}
- ì œì™¸ ë‹¨ì–´: ${avoidTerms || "ì—†ìŒ"}
- ê²€ìƒ‰ ì˜ë„: ${({"info":"ì •ë³´í˜•","compare":"ë¹„êµí˜•","trans":"ê±°ë˜ì „í™˜í˜•","qa":"Q&A ìš”ì•½"}[searchIntent] || searchIntent)}
JSONë§Œ ë°˜í™˜: {"titles":["..."]}` },
          ],
        };
        const resp = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: { "Content-Type": "application/json", Authorization: `Bearer ${apiKey}` },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) throw new Error(`OpenAI ì˜¤ë¥˜: ${resp.status} ${await resp.text()}`);
        const data = await resp.json();
        let content = (data?.choices?.[0]?.message?.content) || "{}";
        content = content.replace(/^```json\n?|\n?```$/g,"");
        const parsed = JSON.parse(content);
        const arr = Array.isArray(parsed.titles) ? parsed.titles : [];
        const avoidList = avoidTerms.split(",").map(s=>s.trim()).filter(Boolean);
        const mustList = mustInclude.split(",").map(s=>s.trim()).filter(Boolean);
        const filtered = arr.filter(t => !avoidList.some(w => w && t.includes(w)))
          .map(t => mustList.length && !mustList.every(w=>t.includes(w)) ? t + " Â· " + mustList.filter(w=>!t.includes(w)).join(" ") : t);
        return (filtered.length ? filtered : arr).slice(0, Math.max(1, Number(n)||5));
      }

      /* ===== ë³¸ë¬¸ ìƒì„± ë¡œì»¬/AI & ê²€ìˆ˜ ===== */
      function addDoubleBreaks(text){ return (!text)?text : text.replace(/([.!?])( *)(?=\S)/g,"$1\n\n").replace(/\n{3,}/g,"\n\n"); }
      function localReview(md){ return (!md)?md : md.replace(/[ \t]+\n/g,"\n").replace(/\n{3,}/g,"\n\n").replace(/ +/g," "); }

      function generateBodyLocal({ title, keyword, minChars }){
        const kws=(keyword||"").split(/[ ,\s]+/).filter(Boolean);
        const main=kws[0]||keyword||"í‚¤ì›Œë“œ";
        const intro=["## ì„œë¡ ",`${main}ì˜ í•µì‹¬ì„ ë¹ ë¥´ê²Œ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ê°œìš”ì™€ ì½ëŠ” ì´ìœ ë¥¼ ë¨¼ì € ì œì‹œí•©ë‹ˆë‹¤.`,"ë³¸ë¬¸ì—ì„œëŠ” ê°œë… â†’ ì ìš© â†’ ì²´í¬ë¦¬ìŠ¤íŠ¸ ìˆœì„œë¡œ ì •ë¦¬í•©ë‹ˆë‹¤."].join("\n");
        const bullets=kws.slice(0,4).map(k=>`- **${k}**: ì™œ ì¤‘ìš”í•œì§€, ì–´ë””ì— ì“°ì´ëŠ”ì§€ í•œ ì¤„ ìš”ì•½`).join("\n");
        const core=["## ë³¸ë¡ ","### í•µì‹¬ ê°œë…",bullets||"- **í•µì‹¬ í¬ì¸íŠ¸**: ì£¼ì œë¥¼ í•œ ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½","", "### ì‚¬ë¡€ì™€ ì ìš©","- ì‹¤ì œ ì ìš© íë¦„ì„ 2~3ë‹¨ê³„ë¡œ ë‚˜ëˆ  ì„¤ëª…","- ìˆ«ì/ë¹„êµ/ë¹„ìœ ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•´ ì´í•´ë„ í–¥ìƒ","", "### ì²´í¬ë¦¬ìŠ¤íŠ¸","- ì˜¤ëŠ˜ ë°”ë¡œ ì ìš©í•  ìˆ˜ ìˆëŠ” 3ê°€ì§€ í–‰ë™","- í”í•œ ì‹¤ìˆ˜ì™€ í”¼í•´ì•¼ í•  ì "].join("\n");
        const outro=["## ê²°ë¡ ",`${main}ì˜ í•µì‹¬ì„ ë‹¤ì‹œ ì •ë¦¬í•˜ê³ , ë‹¤ìŒ í–‰ë™ ì œì•ˆì„ ë§ë¶™ì…ë‹ˆë‹¤.`,`- í•œ ë¬¸ì¥ ìš”ì•½: ${main}ì€(ëŠ”) **ì‘ê²Œ ì‹œì‘í•˜ê³  ë°˜ë³µ**í•  ë•Œ ì„±ê³¼ê°€ ë‚©ë‹ˆë‹¤.`, "- ë‹¤ìŒ ë‹¨ê³„: ì²´í¬ë¦¬ìŠ¤íŠ¸ ì‹¤í–‰ â†’ ê²°ê³¼ ê¸°ë¡ â†’ ê°œì„  í¬ì¸íŠ¸ ë°˜ì˜"].join("\n");
        let md=`# ${title}\n\n${intro}\n\n${core}\n\n${outro}\n\n## í•µì‹¬ ìš”ì•½\n- ${main} í•µì‹¬ë§Œ ê°„ë‹¨íˆ ì •ë¦¬\n- ì˜¤ëŠ˜ ë°”ë¡œ ì ìš©í•  3ê°€ì§€ í–‰ë™\n- ë‹¤ìŒ ê¸€ì—ì„œ ë‹¤ë£° í™•ì¥ ì£¼ì œ ì˜ˆê³ `;
        const minLen=Math.max(400, Number(minChars) || 800);
        while (md.length < minLen) md += `\n\n> ì°¸ê³ : ${main}ì„(ë¥¼) ìµíˆë ¤ë©´ ì‘ì€ ì‹¤í—˜ì„ ê¾¸ì¤€íˆ ë°˜ë³µí•˜ê³  ê¸°ë¡ì„ ë‚¨ê¸°ì„¸ìš”.`;
        return md;
      }

      async function generateBodyAI({ title, keyword, minChars, prompt, context }){
        if(!apiKey) throw new Error("OpenAI API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.");
        const kws=(keyword||"").split(/[ ,\s]+/).filter(Boolean).slice(0,6).join(", ");
        const sys = "You are a professional Korean SEO/copy writer. Output clean Markdown ONLY. Avoid clickbait. Keep headings and lists tidy.";
        const user = `
ì œëª©: ${title}
í‚¤ì›Œë“œ: ${kws||keyword||"í‚¤ì›Œë“œ"}
ìµœì†Œ ê¸€ììˆ˜: ${Math.max(400, Number(minChars)||800)}
ê²€ìƒ‰ ì˜ë„: ${({"info":"ì •ë³´í˜•","compare":"ë¹„êµí˜•","trans":"ê±°ë˜ì „í™˜í˜•","qa":"Q&A ìš”ì•½"}[context.intent]||context.intent)}
ê°ë„/í›„í‚¹: ${({"solve":"ë¬¸ì œ-í•´ê²°","myth":"ì˜¤í•´ ë°”ë¡œì¡ê¸°","check":"ì²´í¬ë¦¬ìŠ¤íŠ¸","compare":"ë¹„êµ/ëŒ€ì•ˆ","mistake":"ì‹¤ìˆ˜ íšŒí”¼"}[context.angle]||context.angle)}
í†¤ ìŠ¤ì¼€ì¼(1=ê°ì„±,5=ì´ì„±): ${toneLevel}

í•„ìˆ˜ í¬í•¨ì–´: ${mustInclude || "ì—†ìŒ"}
í”¼í•´ì•¼ í•  ë‹¨ì–´: ${avoidTerms || "ì—†ìŒ"}
ì°¸ê³  ë¬¸ë‹¨(ì„ íƒ): ${referenceText ? referenceText.slice(0,900) : "ì—†ìŒ"}
ì¶”ê°€ í”„ë¡¬í”„íŠ¸(ì„ íƒ): ${prompt || "ì—†ìŒ"}

ì‘ì„± ì§€ì¹¨:
- êµ¬ì¡°: ì„œë¡  â†’ ë³¸ë¡ (í•µì‹¬ ê°œë… / ì‚¬ë¡€ì™€ ì ìš© / ì²´í¬ë¦¬ìŠ¤íŠ¸) â†’ ê²°ë¡  â†’ í•µì‹¬ ìš”ì•½
- ê³¼ì¥/ë‚šì‹œ ê¸ˆì§€, ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´, ë¶ˆí•„ìš”í•œ ë°˜ë³µ ê¸ˆì§€
- ì†Œì œëª©ì€ '##', '###' ì‚¬ìš©. ëª©ë¡ì€ '-'ë¡œ ì •ë¦¬.
- ì¶œë ¥ì€ **ìˆœìˆ˜ ë§ˆí¬ë‹¤ìš´ ë³¸ë¬¸ë§Œ**.
`.trim();

        const payload = {
          model: OPENAI_MODEL,
          messages: [
            { role:"system", content: sys },
            { role:"user", content: user }
          ],
        };

        const resp = await fetch("https://api.openai.com/v1/chat/completions", {
          method:"POST",
          headers:{ "Content-Type":"application/json", Authorization:`Bearer ${apiKey}` },
          body: JSON.stringify(payload)
        });
        if(!resp.ok) throw new Error(`OpenAI ì˜¤ë¥˜: ${resp.status} ${await resp.text()}`);
        const data = await resp.json();
        return (data?.choices?.[0]?.message?.content || "").replace(/^```(?:md|markdown)?\n?|\n?```$/g,"");
      }

      async function onReview(){
        try{
          if(!markdown.trim()) return;
          setError(""); setReviewing(true);
          const reviewed = (useAI && apiKey) ? await (async ()=>{
            const payload = { model: OPENAI_MODEL, messages:[
              { role:"system", content:"You are a professional Korean copy editor for blog content." },
              { role:"user", content:"ë‹¤ìŒ í•œêµ­ì–´ ë§ˆí¬ë‹¤ìš´ì„ ë¬¸ë²•ê³¼ íë¦„ ìœ„ì£¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ë‹¤ë“¬ì–´ ì£¼ì„¸ìš”. ì˜ë¯¸/ì‚¬ì‹¤/í‚¤ì›Œë“œëŠ” ìœ ì§€í•˜ê³ , ì¶œë ¥ì€ ìˆœìˆ˜ ë§ˆí¬ë‹¤ìš´ë§Œ ì£¼ì„¸ìš”.\n\n---\n\n"+markdown }
            ]};
            const resp=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${apiKey}`},body:JSON.stringify(payload)});
            if(!resp.ok) throw new Error(`OpenAI ì˜¤ë¥˜: ${resp.status} ${await resp.text()}`);
            const data=await resp.json();
            return (data?.choices?.[0]?.message?.content || "").replace(/^```(?:md|markdown)?\n?|\n?```$/g,"");
          })() : localReview(markdown);
          const out = addDoubleBreaks(reviewed);
          setMarkdown(out);
        }catch(e){ setError(e.message||String(e)); }
        finally{ setReviewing(false); }
      }

      async function onGenerateBody(){
        try{
          setError(""); setGenBusy(true);
          let md;
          if (useAI && apiKey && bodyMode==="ai"){
            md = await generateBodyAI({
              title: selectedTitle,
              keyword,
              minChars,
              prompt: referencePrompt,
              context: { intent: searchIntent, angle }
            });
          } else {
            md = generateBodyLocal({ title:selectedTitle, keyword, minChars });
          }
          md = autoSpacing?addDoubleBreaks(md):md;
          setMarkdown(md);
          /* ë³¸ë¬¸ ìƒì„± ì§í›„ ëª¨ë°”ì¼ì—ì„œë„ ë³´ê¸° ì‰½ê²Œ ëª¨ë‹¬ ìë™ ì˜¤í”ˆ */
          setReaderOpen(true);
        }catch(e){ setError(e.message||String(e)); }
        finally{ setGenBusy(false); }
      }

      async function onGenerateTitles(){
        try{
          setError(""); setLoading(true);
          const opts={ toneLevel, format:titleFormat };
          const ctx=[angle && `ê°ë„:${angle}`, searchIntent && `ì˜ë„:${searchIntent}`, mustInclude && `í¬í•¨:${mustInclude}`, avoidTerms && `ì œì™¸:${avoidTerms}`].filter(Boolean).join(" / ");
          const refMerged=[referenceText, ctx, referencePrompt && `í”„ë¡¬í”„íŠ¸:${referencePrompt}`].filter(Boolean).join("\n\n");
          let ideas=[];
          if(useAI && apiKey) ideas = await generateTitleIdeasAI({ baseKeyword:keyword, n:titleCount, ref:refMerged, opts });
          if(!ideas.length) ideas = generateTitleIdeasLocal(keyword, titleCount, refMerged, opts);
          setTitleIdeas(ideas); setSelectedTitle("");
        }catch(e){ setError(e.message||String(e)); }
        finally{ setLoading(false); }
      }

      /* ====== UI ì°¸ì¡° ====== */
      const ref1=useRef(null),ref2=useRef(null),ref3=useRef(null),ref4=useRef(null),ref5=useRef(null),ref6=useRef(null),ref7=useRef(null),ref8=useRef(null);

      /* =================== UI =================== */
      return (
        <div style={styles.app}>
          <header style={styles.header}>
            <div style={styles.container}>
              <div style={{ display:"flex", alignItems:"center", gap:12 }}>
                <div style={styles.logo}>AW</div>
                <h1 style={{ fontSize:18, fontWeight:600, margin:0 }}>ê¸€ì“°ê¸° ìë™í™” í”„ë¡œê·¸ë¨ Â· 3ë‹¨ê³„ ë§ˆë²•ì‚¬</h1>
              </div>
            </div>
          </header>

          <nav style={{ ...styles.tabs, padding:"0 12px" }}>
            {[1,2,3].map(n=>(
              <button key={n} className="mb-full" style={styles.tab(activeStep===n)} onClick={()=>setActiveStep(n)}>{n}ë‹¨ê³„</button>
            ))}
          </nav>

          {/* STEP 3ë§Œ ì˜ˆì‹œë¡œ í‘œì‹œ(1/2/ë‹¨ê³„ UIëŠ” ë™ì¼ êµ¬ì¡°ë¡œ ìœ ì§€) */}
          {activeStep===3&&(
            <section style={{ ...styles.card, ...styles.container }}>
              <div style={styles.stepHead}>
                <h2 style={{ fontSize:16, fontWeight:600, margin:0 }}>3. ì„ íƒí•œ ì œëª©ìœ¼ë¡œ ë³¸ë¬¸ ì‘ì„± & ê²€ìˆ˜</h2>
                <span style={styles.pill}>STEP 3</span>
              </div>

              <div className="grid-4">
                <div style={styles.labelRow}><span>ì„ íƒí•œ ì œëª©</span><Help text="2ë‹¨ê³„ì—ì„œ ê³ ë¥¸ ì œëª©ì„ ì´ê³³ì—ì„œ ìˆ˜ì •í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤."/></div>
                <div style={styles.ctrlWrap}><input value={selectedTitle} onChange={(e)=>setSelectedTitle(e.target.value)} style={{...styles.input, ...styles.ring(true)}}/></div>

                <div style={styles.labelRow}><span>ë³¸ë¬¸ ìµœì†Œ ê¸€ììˆ˜</span><Help text="ìë™ ìƒì„± ì‹œ ìµœì†Œ ê¸€ì ìˆ˜(400 ì´ìƒ ê¶Œì¥)"/></div>
                <div style={styles.ctrlWrap}><input type="number" min={400} step={100} value={minChars} onChange={(e)=>{ const v=parseInt(e.target.value||'0',10); setMinChars(Number.isFinite(v)?v:1200); }} style={{...styles.number}}/></div>

                <div style={styles.labelRow}><span>ì°¸ê³ í•  ê¸€/í”„ë¡¬í”„íŠ¸</span><Help text="ë³¸ë¬¸ ìƒì„± ì‹œ ì°¸ê³ í•  ë¬¸ë‹¨Â·ì§€ì‹œì–´Â·í†¤ ìš”êµ¬ì‚¬í•­ ë“±ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."/></div>
                <div className="ctrl-span-3" style={styles.ctrlWrap}>
                  <textarea value={referencePrompt} onChange={(e)=>setReferencePrompt(e.target.value)} placeholder="ì˜ˆ) í†¤ì€ ì¤‘ë¦½, ì‹¤ë¬´ ì˜ˆì‹œ 2ê°œ, ì²´í¬ë¦¬ìŠ¤íŠ¸ëŠ” 3ê°œë¡œ ì œí•œâ€¦" style={styles.textarea}/>
                </div>

                <div style={styles.labelRow}><span>ë³¸ë¬¸ ìƒì„± ë°©ì‹</span><Help text="AI ì‚¬ìš© + API í‚¤ê°€ ìˆìœ¼ë©´ AI ë³¸ë¬¸ ìƒì„± ê¶Œì¥. ì•„ë‹ˆë©´ ë¡œì»¬ í…œí”Œë¦¿."/></div>
                <div style={styles.ctrlWrap}>
                  <label style={{marginRight:12}}><input type="radio" name="bodymode" value="ai" checked={bodyMode==='ai'} onChange={()=>setBodyMode('ai')}/> <span style={styles.note}>AI</span></label>
                  <label><input type="radio" name="bodymode" value="local" checked={bodyMode==='local'} onChange={()=>setBodyMode('local')}/> <span style={styles.note}>ë¡œì»¬</span></label>
                </div>

                <div className="ctrl-span-3" style={styles.ctrlWrap}>
                  <label style={{ display:"inline-flex", alignItems:"center", gap:8 }}>
                    <input type="checkbox" checked={autoSpacing} onChange={(e)=>setAutoSpacing(e.target.checked)}/>
                    ë¬¸ì¥ ë ì—¬ë°± ìë™ ì¶”ê°€(ì—”í„° 2íšŒ)
                  </label>
                </div>
              </div>

              <div style={{ marginTop:12, display:'flex', gap:8, flexWrap:'wrap' }}>
                <button disabled={!selectedTitle.trim()||genBusy} onClick={onGenerateBody} className="mb-full" style={{ ...styles.btn, opacity:(!selectedTitle.trim()||genBusy)?0.5:1 }}>
                  {genBusy ? "ë³¸ë¬¸ ìƒì„± ì¤‘..." : (useAI && apiKey && bodyMode==="ai" ? "AIë¡œ ë³¸ë¬¸ ìƒì„±" : "ë³¸ë¬¸ ìƒì„±(ë¡œì»¬)")}
                </button>
                <button disabled={!markdown.trim()||reviewing} onClick={onReview} className="mb-full" style={{ ...styles.btnGhost, opacity:(!markdown.trim()||reviewing)?0.5:1 }}>
                  {reviewing?"ê²€ìˆ˜ ì¤‘...":(useAI&&apiKey?"AI ê²€ìˆ˜(ë¬¸ë²•Â·íë¦„)":"ë¹ ë¥¸ ê²€ìˆ˜(ë¡œì»¬)")}
                </button>
                <button disabled={!markdown.trim()} onClick={()=>setReaderOpen(true)} className="mb-full" style={{ ...styles.btnGhost, opacity:(!markdown.trim())?0.5:1 }}>ë³¸ë¬¸ ì „ì²´ ë³´ê¸°</button>
                {error && <span style={{ color: palette.danger, fontSize:12 }}>ì˜¤ë¥˜: {error}</span>}
              </div>

              {/* ì½ê¸° ì¹´ë“œë·° (ì¦‰ì‹œ í™•ì¸ìš©) */}
              {markdown.trim() && (
                <div style={{ marginTop:16 }}>
                  <div style={{ display:"flex", alignItems:"center", justifyContent:"space-between", marginBottom:8 }}>
                    <h3 style={{ ...styles.h3, margin:0 }}>ğŸ“– ë¹ ë¥¸ ë¯¸ë¦¬ì½ê¸°</h3>
                    <div style={{ display:"flex", gap:8, flexWrap:"wrap" }}>
                      <button style={styles.btnGhost} onClick={()=>setReaderOpen(true)}>í™•ëŒ€ ë³´ê¸°</button>
                      <button style={styles.btnGhost} onClick={()=>navigator.clipboard?.writeText(markdown)}>ë§ˆí¬ë‹¤ìš´ ë³µì‚¬</button>
                    </div>
                  </div>
                  <div class="read-card" dangerouslySetInnerHTML={{ __html: html }}></div>
                </div>
              )}

              {/* ê¸°ì¡´ ë¯¸ë¦¬ë³´ê¸°/ì›ë¬¸(í¸ì§‘) ì˜ì—­ */}
              <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:12, marginTop:16 }}>
                <div>
                  <h3 style={styles.h3}>HTML ë¯¸ë¦¬ë³´ê¸°</h3>
                  <div style={styles.prose} dangerouslySetInnerHTML={{ __html: html }} />
                </div>
                <div>
                  <h3 style={styles.h3}>ë§ˆí¬ë‹¤ìš´ ì›ë¬¸</h3>
                  <textarea value={markdown} onChange={(e)=>setMarkdown(e.target.value)} rows={16} style={styles.textarea} />
                </div>
              </div>
            </section>
          )}

          {/* ì „ì²´ ë¦¬ë” ëª¨ë‹¬ */}
          {readerOpen && (
            <div style={styles.overlay} onClick={()=>setReaderOpen(false)}>
              <div style={styles.reader} onClick={(e)=>e.stopPropagation()}>
                <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:8 }}>
                  <strong>ë³¸ë¬¸ ì „ì²´ ë³´ê¸°</strong>
                  <button style={styles.btnGhost} onClick={()=>setReaderOpen(false)}>ë‹«ê¸°</button>
                </div>
                <div class="read-card" dangerouslySetInnerHTML={{ __html: html }}></div>
              </div>
            </div>
          )}

          {/* í•˜ë‹¨ ê³ ì • ë°” (ì„¸ì´í”„ ì—ì–´ë¦¬ì–´ ì ìš©) */}
          <div style={styles.stickyMobile}>
            <button onClick={()=>setActiveStep(Math.max(1,activeStep-1))} style={styles.btnGhost}>ì´ì „</button>
            <div style={{ display:'flex', gap:8 }}>
              {activeStep===3&&(
                <>
                  <button disabled={!selectedTitle.trim()||genBusy} onClick={onGenerateBody} style={{ ...styles.btn, opacity:(!selectedTitle.trim()||genBusy)?0.5:1 }}>
                    {genBusy ? "ë³¸ë¬¸ ìƒì„± ì¤‘..." : (useAI && apiKey && bodyMode==="ai" ? "AI ë³¸ë¬¸" : "ë³¸ë¬¸(ë¡œì»¬)")}
                  </button>
                  <button disabled={!markdown.trim()||reviewing} onClick={onReview} style={{ ...styles.btnGhost, opacity:(!markdown.trim()||reviewing)?0.5:1 }}>
                    {reviewing?"ê²€ìˆ˜ ì¤‘...":(useAI&&apiKey?"AI ê²€ìˆ˜":"ë¹ ë¥¸ ê²€ìˆ˜")}
                  </button>
                </>
              )}
              <button onClick={()=>setActiveStep(Math.min(3,activeStep+1))} style={styles.btn}>ë‹¤ìŒ</button>
            </div>
          </div>
        </div>
      );
    }

    /* =================== Mount =================== */
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<NaverWizardDark />);
  </script>
</body>
</html>