<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>글쓰기 자동화 · 3단계 마법사 (Responsive)</title>

  <!-- React / ReactDOM / Babel (개발용 CDN) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin></script>

  <style>
    /* ---- 글로벌 리셋 & 모바일 넘침 방지 ---- */
    * { box-sizing: border-box; }
    html,body,#root{height:100%;margin:0}
    body{font-family:"Noto Sans KR",system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,"맑은 고딕",Arial,sans-serif;
         -webkit-text-size-adjust:100%; background:#0b0c0f; color:#e7eaf0;}
    input,select,textarea{ font-size:16px; max-width:100%; } /* iOS 확대/넘침 방지 */
    ::-webkit-scrollbar{height:10px;width:10px}
    ::-webkit-scrollbar-thumb{background:#1f2430;border-radius:8px}

    /* ---- 반응형 그리드: 4열 → 2열 → 1열 ---- */
    :root{ --gap:18px; }
    .grid-4{
      display:grid;
      grid-template-columns: 240px 1fr 240px 1fr; /* (라벨)(입력) × 2세트 */
      column-gap: var(--gap);
      row-gap: 20px;
      scroll-margin-top: 76px; /* sticky 헤더 고려 */
    }
    @media (max-width:1024px){
      .grid-4{ grid-template-columns: 1fr 1fr; }
      .ctrl-span-3{ grid-column: 1 / -1 !important; }
    }
    @media (max-width:768px){
      .grid-4{ grid-template-columns: 1fr; row-gap:14px; }
      .ctrl-span-3{ grid-column: 1 / -1 !important; }
    }

    /* ---- 진행 순서 칩: 스냅 + 그라디언트 마스크 ---- */
    .flow-wrap{ position:relative; }
    .flow-chips{
      display:flex; gap:8px; overflow-x:auto; -webkit-overflow-scrolling:touch;
      padding:6px 4px 10px; scrollbar-width:thin; scroll-snap-type:x proximity;
      mask-image: linear-gradient(to right, transparent 0, black 24px, black calc(100% - 24px), transparent 100%);
    }
    .flow-chips > span{ scroll-snap-align:start; }
    .chip{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:9999; font-size:12px; cursor:pointer; }

    /* ---- 모바일 버튼 폭 ---- */
    @media (max-width:768px){ .mb-full{ width:100%; } }

    /* ---- 본문 읽기 카드/모달 ---- */
    .read-card{
      border:1px solid #1b1e25; border-radius:16px; background:#0f1217; padding:16px; 
      line-height:1.7; letter-spacing:.01em;
    }
    .read-card h1,.read-card h2,.read-card h3{ color:#e9edf7; }
    .read-card ul{ padding-left:20px; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const {useState,useEffect,useMemo,useRef,useLayoutEffect} = React;

    function NaverWizardDark(){
      /* =================== Theme & State =================== */
      const palette = {
        bg:"#0b0c0f", card:"#111318", border:"#1b1e25",
        text:"#e7eaf0", muted:"#9aa3b2",
        accent:"#a3bffa", accentPress:"#7aa2f7",
        chip:"#0c0f14", chipActive:"#12203a", chipRing:"#3656ff66",
        danger:"#fda4a4"
      };
      const OPENAI_MODEL = "gpt-4o-mini"; // 안정/가성비

      const [activeStep,setActiveStep] = useState(3);

      // step1
      const [useAI,setUseAI] = useState(false);
      const [apiKey,setApiKey] = useState("");

      // step2
      const [keyword,setKeyword] = useState("");
      const [searchIntent,setSearchIntent] = useState("info");
      const [angle,setAngle] = useState("solve");
      const [toneLevel,setToneLevel] = useState(3);
      const [titleFormat,setTitleFormat] = useState("auto");
      const [formatOpen,setFormatOpen] = useState(false);
      const [mustInclude,setMustInclude] = useState("");
      const [avoidTerms,setAvoidTerms] = useState("");
      const [referenceText,setReferenceText] = useState("");
      const [titleCount,setTitleCount] = useState(5);
      const [titleIdeas,setTitleIdeas] = useState([]);
      const [selectedTitle,setSelectedTitle] = useState("");
      const [flowActive,setFlowActive] = useState(1);

      // step3
      const [minChars,setMinChars] = useState(1200);
      const [markdown,setMarkdown] = useState("");
      const [autoSpacing,setAutoSpacing] = useState(true);
      const [referencePrompt,setReferencePrompt] = useState("");
      const [bodyMode,setBodyMode] = useState("ai"); // 'ai' | 'local'
      const [genBusy,setGenBusy] = useState(false);
      const [readerOpen,setReaderOpen] = useState(false);

      // common
      const [loading,setLoading] = useState(false);
      const [reviewing,setReviewing] = useState(false);
      const [error,setError] = useState("");

      useEffect(()=>{ setApiKey(localStorage.getItem("naverWizard_openai_key")||""); },[]);
      useEffect(()=>{ localStorage.setItem("naverWizard_openai_key", apiKey||""); },[apiKey]);

      /* ============= 공통 스타일 (inline) ============= */
      const styles = {
        app:{ backgroundColor:palette.bg, color:palette.text, minHeight:"100vh",
              paddingBottom:"calc(120px + env(safe-area-inset-bottom))" },
        header:{ position:"sticky", top:0, backdropFilter:"blur(6px)", borderBottom:`1px solid ${palette.border}`, background:"rgba(11,12,15,.65)", marginBottom:16, zIndex:10 },
        container:{ maxWidth:1200, margin:"0 auto", padding:"12px" },
        logo:{ width:36, height:36, borderRadius:16, display:"grid", placeItems:"center", fontWeight:700, background:"linear-gradient(180deg,#20314f,#101828)", color:"#dbe7ff" },
        tabs:{ display:"flex", gap:8, marginBottom:12, flexWrap:"wrap" },
        tab:(active)=>({ border:`1px solid ${palette.border}`, borderRadius:12, padding:"10px 14px", background:active?"#111827":"#0c0f14", color:active?palette.text:palette.muted, cursor:"pointer", minWidth:90 }),
        card:{ background:palette.card, border:`1px solid ${palette.border}`, borderRadius:16, padding:20, marginBottom:16 },
        stepHead:{ borderBottom:`1px solid ${palette.border}`, paddingBottom:8, marginBottom:12, display:"flex", alignItems:"center", justifyContent:"space-between", gap:8, flexWrap:"wrap" },
        pill:{ padding:"2px 9px", borderRadius:9999, fontSize:12, background:"#0f1116", color:palette.muted, border:`1px solid ${palette.border}` },

        labelRow:{ display:"flex", alignItems:"center", gap:6, color:palette.muted, fontSize:12, lineHeight:1.3, minHeight:24 },
        ctrlWrap:{},
        helpChip:{ position:"relative", display:"inline-flex", alignItems:"center", justifyContent:"center",
                   width:18, height:18, borderRadius:"50%", background:"#0e1524", color:"#cfe0ff",
                   border:`1px solid ${palette.border}`, cursor:"pointer", fontWeight:700, fontSize:12, userSelect:"none", flex:"0 0 auto" },
        tooltipBox:{ position:"fixed", background:"#0e1117", color:palette.text, border:`1px solid ${palette.border}`,
                     borderRadius:8, padding:"8px 10px", maxWidth:320, zIndex:1000, boxShadow:"0 10px 22px rgba(0,0,0,.45)", fontSize:12 },

        input:{ background:"#0e1117", color:palette.text, border:`1px solid ${palette.border}`, borderRadius:12, padding:"12px 12px", width:"100%" },
        number:{ background:"#0e1117", color:palette.text, border:`1px solid ${palette.border}`, borderRadius:12, padding:"12px 12px", width:"100%" },
        textarea:{ background:"#0e1117", color:palette.text, border:`1px solid ${palette.border}`, borderRadius:12, padding:12, width:"100%", minHeight:110 },
        ring:(active)=> active ? ({ borderColor:palette.accentPress, boxShadow:`0 0 0 2px ${palette.chipRing}` }) : ({}),

        h3:{ fontWeight:600, marginBottom:8, color:"#e9edf7" },
        prose:{ border:`1px solid ${palette.border}`, background:palette.card, borderRadius:16, padding:16, minHeight:240, overflowX:"auto" },
        btn:{ backgroundImage:`linear-gradient(180deg, ${palette.accent}, ${palette.accentPress})`, color:"#0b1020", fontWeight:600, borderRadius:14, padding:"10px 16px", border:0, cursor:"pointer" },
        btnGhost:{ background:"transparent", color:palette.text, border:`1px solid ${palette.border}`, borderRadius:12, padding:"9px 14px", cursor:"pointer" },
        note:{ fontSize:12, color:palette.muted },

        stickyMobile:{ position:"fixed", bottom:0, left:0, right:0, background:"rgba(11,12,15,.9)", borderTop:`1px solid ${palette.border}`,
                       padding:"10px", paddingBottom:"calc(10px + env(safe-area-inset-bottom))",
                       display:"flex", gap:8, justifyContent:"space-between", zIndex:20 },

        overlay:{ position:"fixed", inset:0, background:"rgba(0,0,0,.6)", display:"flex", alignItems:"center", justifyContent:"center", zIndex:1000 },
        reader:{ width:"min(1000px, 92vw)", height:"min(80vh, 760px)", background:palette.card, border:`1px solid ${palette.border}`, borderRadius:16, padding:16, overflow:"auto" }
      };

      /* ====== 툴팁: 뷰포트 밖 방지 ====== */
      function Help({text}){
        const btnRef = useRef(null);
        const tipRef = useRef(null);
        const [open,setOpen] = useState(false);
        const [pos,setPos] = useState({top:0,left:0});

        const place = () => {
          if(!btnRef.current) return;
          const r = btnRef.current.getBoundingClientRect();
          const estW = Math.min(320, Math.max(220, window.innerWidth*0.92));
          const estH = 140;
          let left = r.left + r.width/2 - estW/2;
          left = Math.max(8, Math.min(left, window.innerWidth - estW - 8));
          let top = r.bottom + 8;
          if (top + estH > window.innerHeight - 8) { top = r.top - estH - 8; if (top < 8) top = 8; }
          setPos({top,left});
          setTimeout(()=>{
            if (!tipRef.current) return;
            const tr = tipRef.current.getBoundingClientRect();
            let l = tr.left, t = tr.top;
            if (tr.right > window.innerWidth - 8) l -= (tr.right - (window.innerWidth - 8));
            if (tr.left < 8) l = 8;
            if (tr.bottom > window.innerHeight - 8) t -= (tr.bottom - (window.innerHeight - 8));
            if (tr.top < 8) t = 8;
            tipRef.current.style.left = `${l}px`;
            tipRef.current.style.top  = `${t}px`;
          },0);
        };

        useLayoutEffect(()=>{ if(open) place(); },[open]);
        useEffect(()=>{
          const h=()=> open && place();
          window.addEventListener('scroll',h,true);
          window.addEventListener('resize',h);
          return ()=>{ window.removeEventListener('scroll',h,true); window.removeEventListener('resize',h); };
        },[open]);

        return (
          <>
            <span
              ref={btnRef}
              style={styles.helpChip}
              onMouseEnter={()=>setOpen(true)}
              onMouseLeave={()=>setOpen(false)}
              onClick={()=>setOpen(o=>!o)}
              onTouchStart={(e)=>{ e.preventDefault(); setOpen(o=>!o); }}
              aria-label="도움말"
            >?</span>
            {open && <div ref={tipRef} style={{...styles.tooltipBox, top:pos.top, left:pos.left, maxWidth:"92vw" }}>{text}</div>}
          </>
        );
      }

      /* ===== Markdown → HTML ===== */
      function mdToHtml(md){
        let h = md || "";
        h = h.replace(/^# (.+)$/gm, "<h1>$1</h1>");
        h = h.replace(/^## (.+)$/gm, "<h2>$1</h2>");
        h = h.replace(/^### (.+)$/gm, "<h3>$1</h3>");
        h = h.replace(/^> (.+)$/gm, "<blockquote>$1</blockquote>");
        h = h.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
        h = h.replace(/\*(.+?)\*/g, "<em>$1</em>");
        h = h.replace(/`([^`]+)`/g, "<code>$1</code>");
        h = h.replace(/^\s*[-*]\s+(.+)$/gm, "<li>$1</li>");
        h = h.replace(/(<li>.*<\/li>\n?)+/g, (m) => "<ul>" + m + "</ul>");
        h = h.replace(/\n\n+/g, "<br/><br/>");
        return h;
      }
      const html = useMemo(()=>mdToHtml(markdown),[markdown]);

      /* === 여기서부터 2/2 이어붙이기 === */
            /* ===== 유틸 ===== */
      function topTerms(text,k=5){
        const stop=new Set(["그리고","그러나","하지만","또는","또","이미","또한","그","이","저","것","수","때문","대한","에서","으로","하기","하는","있는","없는","합니다","했다","이다","같은","등","더","좀","매우","너무","되다","하다","있다","없다"]);
        const c=Object.create(null);
        (text||"").toLowerCase().replace(/[^\p{L}\p{N}\s]/gu," ").split(/\s+/)
          .filter(w=>w&&w.length>1&&!stop.has(w)).forEach(w=>{c[w]=(c[w]||0)+1});
        return Object.entries(c).sort((a,b)=>b[1]-a[1]).slice(0,k).map(([w])=>w);
      }

      /* ===== 제목 생성 로컬/AI ===== */
      function buildContextSnippet(){
        const parts=[];
        const angleName={solve:"문제-해결",myth:"오해 바로잡기",check:"체크리스트",compare:"비교/대안",mistake:"실수 회피"}[angle]||angle;
        const intentName={info:"정보형",compare:"비교형",trans:"거래전환형",qa:"Q&A 요약"}[searchIntent]||searchIntent;
        parts.push(`각도:${angleName}`,`의도:${intentName}`);
        if(mustInclude.trim()) parts.push(`포함:${mustInclude.trim()}`);
        if(avoidTerms.trim()) parts.push(`제외:${avoidTerms.trim()}`);
        const ref = referenceText.trim() ? `참고:${referenceText.trim().slice(0,180)}…` : "";
        return (parts.join(" / ") + (ref ? " / " + ref : "")).trim();
      }
      function generateTitleIdeasLocal(baseKeyword,n,ref,opts={toneLevel:3,format:"auto"}){
        if(!baseKeyword||!baseKeyword.trim()) return [];
        const base = baseKeyword.trim();
        const refTerms = topTerms(ref,4);
        const refHint = refTerms.length ? ` (${refTerms.join(" · ")})` : "";
        const ctx = buildContextSnippet();
        const em = opts.toneLevel ?? 3;
        const emotional = em <= 2.0, rational = em >= 4.0;

        const emoHooks=[`${base}의 숨은 혜택`,`${base}로 달라지는 하루`,`${base}를 알면 편해지는 이유`,`${base} 작은 비밀`];
        const ratHooks=[`${base} 핵심 지표`,`${base} 3가지 핵심`,`${base} 실무 체크리스트`,`${base} 데이터로 보는 변화`];
        const angleFrames={
          solve:[`${base} 문제 해결 가이드`,`${base} 이렇게 하면 풀립니다`],
          myth:[`${base}에 대한 흔한 오해 3가지`,`${base} 사실과 오해`],
          check:[`${base} 점검 체크리스트`,`${base} 준비물/조건 총정리`],
          compare:[`${base} 비교: 선택 기준과 대안`,`${base} vs 유사 개념: 차이와 활용`],
          mistake:[`${base} 할 때 흔한 실수와 피하는 법`,`${base} 실패 줄이는 법`],
        }[angle]||[];
        const intentFrames={
          info:[`${base} 핵심만 요약`,`${base} 무엇부터 알면 좋을까?`],
          compare:[`${base} 선택 가이드`,`${base} 비교표로 보는 차이`],
          trans:[`왜 지금 ${base}를 고려해야 할까`,`${base} 도입 전 확인할 3가지`],
          qa:[`${base} Q&A: 자주 묻는 질문`,`${base} 상담전 미리 보는 핵심`],
        }[searchIntent]||[];

        const frames=[
          ...(emotional?[`${emoHooks[0]}: 알아두면 득이 되는 가이드${refHint||""}`,`모두가 지나치는 ${base}의 ${emoHooks[3]}${refHint||""}`]:[]),
          ...(rational?[`${ratHooks[1]}: 실전 적용 포인트${refHint||""}`,`${base} ${ratHooks[2]} (실무 기준)${refHint||""}`]:[]),
          ...angleFrames.map(f=>`${f}${ctx ? " · " + ctx : ""}`),
          ...intentFrames.map(f=>`${f}${ctx ? " · " + ctx : ""}`),
          `${base} 최신 트렌드와 사례: 지금 적용하는 법${refHint}`,
          `${base} 핵심만 요약: 꼭 알아야 할 체크포인트${refHint}`,
        ];

        function byFormat(s){
          switch(opts.format){
            case "question": return `${base}는 무엇일까? ${refTerms[0]?`(${refTerms[0]})`:""}`.trim();
            case "command":  return `지금 알아야 할 ${base} 핵심 가이드`;
            case "list":     return `${base} 핵심 포인트 3가지`;
            case "compare":  return `${base} 전/후 비교: 달라진 점과 대응`;
            default:         return s;
          }
        }
        const mustList = mustInclude.split(",").map(s=>s.trim()).filter(Boolean);
        const avoidList = avoidTerms.split(",").map(s=>s.trim()).filter(Boolean);

        const shuffled = [...frames].sort(()=>Math.random()-0.5);
        const count = Math.max(1,Number(n)||5), out=[], used=new Set();
        for(let i=0;i<shuffled.length && out.length<count;i++){
          let f = byFormat(shuffled[i]);
          if (mustList.length && !mustList.every(w=>f.includes(w))) f += " · " + mustList.filter(w=>!f.includes(w)).join(" ");
          if (avoidList.some(w=>w && f.includes(w))) continue;
          if (!used.has(f)) { used.add(f); out.push(f); }
        }
        while(out.length<count){
          const fb = `${base} 가이드: 시작하는 법${ctx ? " · " + ctx : ""}`;
          if (!avoidList.some(w=>fb.includes(w))) out.push(fb); else break;
        }
        return out.slice(0,count);
      }

      async function generateTitleIdeasAI({ baseKeyword, n, ref, opts }){
        if(!apiKey) throw new Error("OpenAI API 키를 먼저 입력하세요.");
        const payload = {
          model: OPENAI_MODEL,
          messages: [
            { role: "system", content: "You generate Korean blog title ideas only. Return STRICT JSON with the schema {\"titles\":[\"...\"]}." },
            { role: "user", content:
`키워드: ${baseKeyword}
제목 개수: ${Math.max(1, Number(n)||5)}
참고 내용(선택): ${(ref||"").slice(0, 2000)}
제목 형식: ${opts?.format || 'auto'}
톤(1=감성,5=이성): ${opts?.toneLevel ?? 3}
- 각도/후킹: ${({"solve":"문제-해결","myth":"오해 바로잡기","check":"체크리스트","compare":"비교/대안","mistake":"실수 회피"}[angle] || angle)}
- 포함 단어: ${mustInclude || "없음"}
- 제외 단어: ${avoidTerms || "없음"}
- 검색 의도: ${({"info":"정보형","compare":"비교형","trans":"거래전환형","qa":"Q&A 요약"}[searchIntent] || searchIntent)}
JSON만 반환: {"titles":["..."]}` },
          ],
        };
        const resp = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: { "Content-Type": "application/json", Authorization: `Bearer ${apiKey}` },
          body: JSON.stringify(payload),
        });
        if (!resp.ok) throw new Error(`OpenAI 오류: ${resp.status} ${await resp.text()}`);
        const data = await resp.json();
        let content = (data?.choices?.[0]?.message?.content) || "{}";
        content = content.replace(/^```json\n?|\n?```$/g,"");
        const parsed = JSON.parse(content);
        const arr = Array.isArray(parsed.titles) ? parsed.titles : [];
        const avoidList = avoidTerms.split(",").map(s=>s.trim()).filter(Boolean);
        const mustList = mustInclude.split(",").map(s=>s.trim()).filter(Boolean);
        const filtered = arr.filter(t => !avoidList.some(w => w && t.includes(w)))
          .map(t => mustList.length && !mustList.every(w=>t.includes(w)) ? t + " · " + mustList.filter(w=>!t.includes(w)).join(" ") : t);
        return (filtered.length ? filtered : arr).slice(0, Math.max(1, Number(n)||5));
      }

      /* ===== 본문 생성 로컬/AI & 검수 ===== */
      function addDoubleBreaks(text){ return (!text)?text : text.replace(/([.!?])( *)(?=\S)/g,"$1\n\n").replace(/\n{3,}/g,"\n\n"); }
      function localReview(md){ return (!md)?md : md.replace(/[ \t]+\n/g,"\n").replace(/\n{3,}/g,"\n\n").replace(/ +/g," "); }

      function generateBodyLocal({ title, keyword, minChars }){
        const kws=(keyword||"").split(/[ ,\s]+/).filter(Boolean);
        const main=kws[0]||keyword||"키워드";
        const intro=["## 서론",`${main}의 핵심을 빠르게 이해할 수 있도록 개요와 읽는 이유를 먼저 제시합니다.`,"본문에서는 개념 → 적용 → 체크리스트 순서로 정리합니다."].join("\n");
        const bullets=kws.slice(0,4).map(k=>`- **${k}**: 왜 중요한지, 어디에 쓰이는지 한 줄 요약`).join("\n");
        const core=["## 본론","### 핵심 개념",bullets||"- **핵심 포인트**: 주제를 한 문장으로 요약","", "### 사례와 적용","- 실제 적용 흐름을 2~3단계로 나눠 설명","- 숫자/비교/비유를 적절히 사용해 이해도 향상","", "### 체크리스트","- 오늘 바로 적용할 수 있는 3가지 행동","- 흔한 실수와 피해야 할 점"].join("\n");
        const outro=["## 결론",`${main}의 핵심을 다시 정리하고, 다음 행동 제안을 덧붙입니다.`,`- 한 문장 요약: ${main}은(는) **작게 시작하고 반복**할 때 성과가 납니다.`, "- 다음 단계: 체크리스트 실행 → 결과 기록 → 개선 포인트 반영"].join("\n");
        let md=`# ${title}\n\n${intro}\n\n${core}\n\n${outro}\n\n## 핵심 요약\n- ${main} 핵심만 간단히 정리\n- 오늘 바로 적용할 3가지 행동\n- 다음 글에서 다룰 확장 주제 예고`;
        const minLen=Math.max(400, Number(minChars) || 800);
        while (md.length < minLen) md += `\n\n> 참고: ${main}을(를) 익히려면 작은 실험을 꾸준히 반복하고 기록을 남기세요.`;
        return md;
      }

      async function generateBodyAI({ title, keyword, minChars, prompt, context }){
        if(!apiKey) throw new Error("OpenAI API 키를 먼저 입력하세요.");
        const kws=(keyword||"").split(/[ ,\s]+/).filter(Boolean).slice(0,6).join(", ");
        const sys = "You are a professional Korean SEO/copy writer. Output clean Markdown ONLY. Avoid clickbait. Keep headings and lists tidy.";
        const user = `
제목: ${title}
키워드: ${kws||keyword||"키워드"}
최소 글자수: ${Math.max(400, Number(minChars)||800)}
검색 의도: ${({"info":"정보형","compare":"비교형","trans":"거래전환형","qa":"Q&A 요약"}[context.intent]||context.intent)}
각도/후킹: ${({"solve":"문제-해결","myth":"오해 바로잡기","check":"체크리스트","compare":"비교/대안","mistake":"실수 회피"}[context.angle]||context.angle)}
톤 스케일(1=감성,5=이성): ${toneLevel}

필수 포함어: ${mustInclude || "없음"}
피해야 할 단어: ${avoidTerms || "없음"}
참고 문단(선택): ${referenceText ? referenceText.slice(0,900) : "없음"}
추가 프롬프트(선택): ${prompt || "없음"}

작성 지침:
- 구조: 서론 → 본론(핵심 개념 / 사례와 적용 / 체크리스트) → 결론 → 핵심 요약
- 과장/낚시 금지, 자연스러운 한국어, 불필요한 반복 금지
- 소제목은 '##', '###' 사용. 목록은 '-'로 정리.
- 출력은 **순수 마크다운 본문만**.
`.trim();

        const payload = {
          model: OPENAI_MODEL,
          messages: [
            { role:"system", content: sys },
            { role:"user", content: user }
          ],
        };

        const resp = await fetch("https://api.openai.com/v1/chat/completions", {
          method:"POST",
          headers:{ "Content-Type":"application/json", Authorization:`Bearer ${apiKey}` },
          body: JSON.stringify(payload)
        });
        if(!resp.ok) throw new Error(`OpenAI 오류: ${resp.status} ${await resp.text()}`);
        const data = await resp.json();
        return (data?.choices?.[0]?.message?.content || "").replace(/^```(?:md|markdown)?\n?|\n?```$/g,"");
      }

      async function onReview(){
        try{
          if(!markdown.trim()) return;
          setError(""); setReviewing(true);
          const reviewed = (useAI && apiKey) ? await (async ()=>{
            const payload = { model: OPENAI_MODEL, messages:[
              { role:"system", content:"You are a professional Korean copy editor for blog content." },
              { role:"user", content:"다음 한국어 마크다운을 문법과 흐름 위주로 자연스럽게 다듬어 주세요. 의미/사실/키워드는 유지하고, 출력은 순수 마크다운만 주세요.\n\n---\n\n"+markdown }
            ]};
            const resp=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${apiKey}`},body:JSON.stringify(payload)});
            if(!resp.ok) throw new Error(`OpenAI 오류: ${resp.status} ${await resp.text()}`);
            const data=await resp.json();
            return (data?.choices?.[0]?.message?.content || "").replace(/^```(?:md|markdown)?\n?|\n?```$/g,"");
          })() : localReview(markdown);
          const out = addDoubleBreaks(reviewed);
          setMarkdown(out);
        }catch(e){ setError(e.message||String(e)); }
        finally{ setReviewing(false); }
      }

      async function onGenerateBody(){
        try{
          setError(""); setGenBusy(true);
          let md;
          if (useAI && apiKey && bodyMode==="ai"){
            md = await generateBodyAI({
              title: selectedTitle,
              keyword,
              minChars,
              prompt: referencePrompt,
              context: { intent: searchIntent, angle }
            });
          } else {
            md = generateBodyLocal({ title:selectedTitle, keyword, minChars });
          }
          md = autoSpacing?addDoubleBreaks(md):md;
          setMarkdown(md);
          /* 본문 생성 직후 모바일에서도 보기 쉽게 모달 자동 오픈 */
          setReaderOpen(true);
        }catch(e){ setError(e.message||String(e)); }
        finally{ setGenBusy(false); }
      }

      async function onGenerateTitles(){
        try{
          setError(""); setLoading(true);
          const opts={ toneLevel, format:titleFormat };
          const ctx=[angle && `각도:${angle}`, searchIntent && `의도:${searchIntent}`, mustInclude && `포함:${mustInclude}`, avoidTerms && `제외:${avoidTerms}`].filter(Boolean).join(" / ");
          const refMerged=[referenceText, ctx, referencePrompt && `프롬프트:${referencePrompt}`].filter(Boolean).join("\n\n");
          let ideas=[];
          if(useAI && apiKey) ideas = await generateTitleIdeasAI({ baseKeyword:keyword, n:titleCount, ref:refMerged, opts });
          if(!ideas.length) ideas = generateTitleIdeasLocal(keyword, titleCount, refMerged, opts);
          setTitleIdeas(ideas); setSelectedTitle("");
        }catch(e){ setError(e.message||String(e)); }
        finally{ setLoading(false); }
      }

      /* ====== UI 참조 ====== */
      const ref1=useRef(null),ref2=useRef(null),ref3=useRef(null),ref4=useRef(null),ref5=useRef(null),ref6=useRef(null),ref7=useRef(null),ref8=useRef(null);

      /* =================== UI =================== */
      return (
        <div style={styles.app}>
          <header style={styles.header}>
            <div style={styles.container}>
              <div style={{ display:"flex", alignItems:"center", gap:12 }}>
                <div style={styles.logo}>AW</div>
                <h1 style={{ fontSize:18, fontWeight:600, margin:0 }}>글쓰기 자동화 프로그램 · 3단계 마법사</h1>
              </div>
            </div>
          </header>

          <nav style={{ ...styles.tabs, padding:"0 12px" }}>
            {[1,2,3].map(n=>(
              <button key={n} className="mb-full" style={styles.tab(activeStep===n)} onClick={()=>setActiveStep(n)}>{n}단계</button>
            ))}
          </nav>

          {/* STEP 3만 예시로 표시(1/2/단계 UI는 동일 구조로 유지) */}
          {activeStep===3&&(
            <section style={{ ...styles.card, ...styles.container }}>
              <div style={styles.stepHead}>
                <h2 style={{ fontSize:16, fontWeight:600, margin:0 }}>3. 선택한 제목으로 본문 작성 & 검수</h2>
                <span style={styles.pill}>STEP 3</span>
              </div>

              <div className="grid-4">
                <div style={styles.labelRow}><span>선택한 제목</span><Help text="2단계에서 고른 제목을 이곳에서 수정할 수도 있습니다."/></div>
                <div style={styles.ctrlWrap}><input value={selectedTitle} onChange={(e)=>setSelectedTitle(e.target.value)} style={{...styles.input, ...styles.ring(true)}}/></div>

                <div style={styles.labelRow}><span>본문 최소 글자수</span><Help text="자동 생성 시 최소 글자 수(400 이상 권장)"/></div>
                <div style={styles.ctrlWrap}><input type="number" min={400} step={100} value={minChars} onChange={(e)=>{ const v=parseInt(e.target.value||'0',10); setMinChars(Number.isFinite(v)?v:1200); }} style={{...styles.number}}/></div>

                <div style={styles.labelRow}><span>참고할 글/프롬프트</span><Help text="본문 생성 시 참고할 문단·지시어·톤 요구사항 등을 붙여넣으세요."/></div>
                <div className="ctrl-span-3" style={styles.ctrlWrap}>
                  <textarea value={referencePrompt} onChange={(e)=>setReferencePrompt(e.target.value)} placeholder="예) 톤은 중립, 실무 예시 2개, 체크리스트는 3개로 제한…" style={styles.textarea}/>
                </div>

                <div style={styles.labelRow}><span>본문 생성 방식</span><Help text="AI 사용 + API 키가 있으면 AI 본문 생성 권장. 아니면 로컬 템플릿."/></div>
                <div style={styles.ctrlWrap}>
                  <label style={{marginRight:12}}><input type="radio" name="bodymode" value="ai" checked={bodyMode==='ai'} onChange={()=>setBodyMode('ai')}/> <span style={styles.note}>AI</span></label>
                  <label><input type="radio" name="bodymode" value="local" checked={bodyMode==='local'} onChange={()=>setBodyMode('local')}/> <span style={styles.note}>로컬</span></label>
                </div>

                <div className="ctrl-span-3" style={styles.ctrlWrap}>
                  <label style={{ display:"inline-flex", alignItems:"center", gap:8 }}>
                    <input type="checkbox" checked={autoSpacing} onChange={(e)=>setAutoSpacing(e.target.checked)}/>
                    문장 끝 여백 자동 추가(엔터 2회)
                  </label>
                </div>
              </div>

              <div style={{ marginTop:12, display:'flex', gap:8, flexWrap:'wrap' }}>
                <button disabled={!selectedTitle.trim()||genBusy} onClick={onGenerateBody} className="mb-full" style={{ ...styles.btn, opacity:(!selectedTitle.trim()||genBusy)?0.5:1 }}>
                  {genBusy ? "본문 생성 중..." : (useAI && apiKey && bodyMode==="ai" ? "AI로 본문 생성" : "본문 생성(로컬)")}
                </button>
                <button disabled={!markdown.trim()||reviewing} onClick={onReview} className="mb-full" style={{ ...styles.btnGhost, opacity:(!markdown.trim()||reviewing)?0.5:1 }}>
                  {reviewing?"검수 중...":(useAI&&apiKey?"AI 검수(문법·흐름)":"빠른 검수(로컬)")}
                </button>
                <button disabled={!markdown.trim()} onClick={()=>setReaderOpen(true)} className="mb-full" style={{ ...styles.btnGhost, opacity:(!markdown.trim())?0.5:1 }}>본문 전체 보기</button>
                {error && <span style={{ color: palette.danger, fontSize:12 }}>오류: {error}</span>}
              </div>

              {/* 읽기 카드뷰 (즉시 확인용) */}
              {markdown.trim() && (
                <div style={{ marginTop:16 }}>
                  <div style={{ display:"flex", alignItems:"center", justifyContent:"space-between", marginBottom:8 }}>
                    <h3 style={{ ...styles.h3, margin:0 }}>📖 빠른 미리읽기</h3>
                    <div style={{ display:"flex", gap:8, flexWrap:"wrap" }}>
                      <button style={styles.btnGhost} onClick={()=>setReaderOpen(true)}>확대 보기</button>
                      <button style={styles.btnGhost} onClick={()=>navigator.clipboard?.writeText(markdown)}>마크다운 복사</button>
                    </div>
                  </div>
                  <div class="read-card" dangerouslySetInnerHTML={{ __html: html }}></div>
                </div>
              )}

              {/* 기존 미리보기/원문(편집) 영역 */}
              <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:12, marginTop:16 }}>
                <div>
                  <h3 style={styles.h3}>HTML 미리보기</h3>
                  <div style={styles.prose} dangerouslySetInnerHTML={{ __html: html }} />
                </div>
                <div>
                  <h3 style={styles.h3}>마크다운 원문</h3>
                  <textarea value={markdown} onChange={(e)=>setMarkdown(e.target.value)} rows={16} style={styles.textarea} />
                </div>
              </div>
            </section>
          )}

          {/* 전체 리더 모달 */}
          {readerOpen && (
            <div style={styles.overlay} onClick={()=>setReaderOpen(false)}>
              <div style={styles.reader} onClick={(e)=>e.stopPropagation()}>
                <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:8 }}>
                  <strong>본문 전체 보기</strong>
                  <button style={styles.btnGhost} onClick={()=>setReaderOpen(false)}>닫기</button>
                </div>
                <div class="read-card" dangerouslySetInnerHTML={{ __html: html }}></div>
              </div>
            </div>
          )}

          {/* 하단 고정 바 (세이프 에어리어 적용) */}
          <div style={styles.stickyMobile}>
            <button onClick={()=>setActiveStep(Math.max(1,activeStep-1))} style={styles.btnGhost}>이전</button>
            <div style={{ display:'flex', gap:8 }}>
              {activeStep===3&&(
                <>
                  <button disabled={!selectedTitle.trim()||genBusy} onClick={onGenerateBody} style={{ ...styles.btn, opacity:(!selectedTitle.trim()||genBusy)?0.5:1 }}>
                    {genBusy ? "본문 생성 중..." : (useAI && apiKey && bodyMode==="ai" ? "AI 본문" : "본문(로컬)")}
                  </button>
                  <button disabled={!markdown.trim()||reviewing} onClick={onReview} style={{ ...styles.btnGhost, opacity:(!markdown.trim()||reviewing)?0.5:1 }}>
                    {reviewing?"검수 중...":(useAI&&apiKey?"AI 검수":"빠른 검수")}
                  </button>
                </>
              )}
              <button onClick={()=>setActiveStep(Math.min(3,activeStep+1))} style={styles.btn}>다음</button>
            </div>
          </div>
        </div>
      );
    }

    /* =================== Mount =================== */
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<NaverWizardDark />);
  </script>
</body>
</html>